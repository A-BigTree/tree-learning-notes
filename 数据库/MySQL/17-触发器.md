# 17 触发器

​	在实际开发中，我们经常会遇到这样的情况：有 2 个或者多个相互关联的表，如 `商品信息` 和 `库存信息` 分别存放在 2 个不同的数据表中，我们在添加一条新商品记录的时候，为了保证数据的完整性，必须同时在库存表中添加一条库存记录。

这样一来，我们就必须把这两个关联的操作步骤写到程序里面，而且要用 `事务` 包裹起来，确保这两个操作成为一个 `原子操作` ，要么全部执行，要么全部不执行。要是遇到特殊情况，可能还需要对数据进行手动维护，这样就很 `容易忘记其中的一步` ，导致数据缺失。

这个时候，咱们可以使用触发器。**<u>你可以创建一个触发器，让商品信息数据的插入操作自动触发库存数据的插入操作。</u>**这样一来，就不用担心因为忘记添加库存数据而导致的数据缺失了。

## 17.1 触发器概述

MySQL从`5.0.2` 版本开始支持触发器。MySQL的触发器和存储过程一样，都是嵌入到MySQL服务器的一段程序。

触发器是由 `事件来触发` 某个操作，这些事件包括 `INSERT` 、 `UPDATE` 、 `DELETE` 事件。所谓事件就是指用户的动作或者触发某项行为。如果定义了触发程序，当数据库执行这些语句时候，就相当于事件发生了，就会 `自动` 激发触发器执行相应的操作。

当对数据表中的数据执行插入、更新和删除操作，需要自动执行一些数据库逻辑时，可以使用触发器来实现。

## 17.2 触发器的创建

### 17.2.1 创建触发器语法

```mysql
CREATE TRIGGER 触发器名称
{BEFORE|AFTER} {INSERT|UPDATE|DELETE} ON 表名
FOR EACH ROW
	触发器执行的语句块;
```

说明：

- 表名 ：表示触发器监控的对象；
- `BEFORE|AFTER` ：表示触发的时间。`BEFORE` 表示在事件之前触发；`AFTER` 表示在事件之后触发；
- `INSERT|UPDATE|DELETE` ：表示触发的事件；
  - `INSERT` 表示插入记录时触发； 
  - `UPDATE` 表示更新记录时触发； 
  - `DELETE` 表示删除记录时触发；
- 触发器执行的语句块 ：可以是单条`SQL`语句，也可以是由`BEGIN…END`结构组成的复合语句块；

### 17.2.2 代码示例

创建触发器：创建名称为`before_insert`的触发器，向`test_trigger`数据表插入数据之前，向`test_trigger_log`数据表中插入`before_insert`的日志信息。

```mysql
DELIMITER //

CREATE TRIGGER before_insert
BEFORE INSERT ON test_trigger
FOR EACH ROW
BEGIN
    INSERT INTO test_trigger_log (t_log)
    VALUES('before_insert');
END //

DELIMITER ;
```

## 17.3 查看、删除触发器

### 17.3.1 查看触发器

查看触发器是查看数据库中已经存在的触发器的定义、状态和语法信息等。

方式1：查看当前数据库的所有触发器的定义

```mysql
SHOW TRIGGERS\G
```

方式2：查看当前数据库中某个触发器的定义  

```mysql
SHOW CREATE TRIGGER 触发器名
```

方式3：从系统库`information_schema`的`TRIGGERS`表中查询`salary_check_trigger`触发器的信息  

```mysql
SELECT * FROM information_schema.TRIGGERS;
```

### 17.3.2 删除触发器

触发器也是数据库对象，删除触发器也用`DROP`语句，语法格式如下：  

```mysql
DROP TRIGGER IF EXISTS 触发器名称;
```

## 17.4 触发器的优缺点

### 17.4.1 优点

1. **<u>触发器可以确保数据的完整性</u>**；

2. **<u>触发器可以帮助我们记录操作日志</u>**；

   利用触发器，可以具体记录什么时间发生了什么。比如，记录修改会员储值金额的触发器，就是一个很好的例子。这对我们还原操作执行时的具体场景，更好地定位问题原因很有帮助；

3. **<u>触发器还可以用在操作数据前</u>**，对数据进行合法性检查；

### 17.4.2 缺点

1. **<u>触发器最大的一个问题就是可读性差</u>**；
2. **<u>相关数据的变更，可能会导致触发器出错</u>**；

### 17.4.3 注意点

注意，如果在子表中定义了外键约束，并且外键指定了`ON UPDATE/DELETE CASCADE/SET NULL`子句，此时修改父表被引用的键值或删除父表被引用的记录行时，也会引起子表的修改和删除操作，此时基于子表的`UPDATE`和`DELETE`语句定义的触发器并不会被激活。
