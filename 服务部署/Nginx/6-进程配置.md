# 6 进程配置

## 6.1 进程管理

Nginx本身是一款应用软件，在其运行时，用户可对其运行方式、动态加载模块、日志输出等使用其内建的基础配置指令进行配置，指令说明如下表所示：

| 指令        | 默认值               | 指令说明                                                     |
| :---------- | :------------------- | :----------------------------------------------------------- |
| daemon      | on                   | 用于设定 Nginx 进程是否以守护进程的方式在后台运行，on 为启用，off 为不启用 |
| pid         | logs/nginx.pid       | 设定保存 Nginx 主进程 ID 的文件路径                          |
| user        | nobody nobody        | 用于设定 Nginx 启动后，主进程唤起的工作进程运行的用户及用户组 |
| load_module | --                   | 加载动态模块的指令                                           |
| include     | --                   | 加载外部配置文件                                             |
| error_log   | logs/error.log error | 指定错误日志文件路径及文件名                                 |
| pcre_jit    | off                  | 用于设定在配置文件中的正则表达式是否使用 pcre_jit 技术，off 为不使用，on 为使用 |
| ssl_engine  | --                   | 指定使用的OpenSSL加速引擎名称                                |

其中，`pcre_jit`需要Nginx在配置编译时加上`--with-pcre-jit`参数；error_log 的日志级别可以为如下值：`debug、info、notice、warn、error、crit、alert、emerg`。

在 Linux 系统中，可用如下命令查看当前系统支持的OpenSSL加速引擎信息：

- `openssl engine -t`

## 6.2 进程调优

Nginx 是按照事件驱动架构设计的。每个外部请求都以事件的形式被工作进程（Worker Process）响应，并发完成各种功能的操作处理。Nginx工作进程的性能依赖于硬件和操作系统的配置，在实际应用场景中，用户需要按照硬件、操作系统或应用场景需求的侧重点进行相应的配置调整。

Nginx的进程调优配置指令如下面表格中所示：

### 6.2.1 线程池指令

| 名 称    | 线程池指令                                                   |
| :------- | :----------------------------------------------------------- |
| 指令     | thread_pool                                                  |
| 作用 域  | main                                                         |
| 默认值   | thread_pool default threads=32 max_queue=65536;              |
| 指令说明 | 线程池配置指令，允许调整默认线程池或创建新的线程池，用于读取和发送文件的场景中。在线程池中所有线程都繁忙时，新的请求任务将在队列中等待，默认情况下，等待队列中的最大任务数是65536，使用线程池机制时，通过配置该指令，可以在因读取和发送文件引发阻塞的场景中提升Nginx读取和发送文件的处理性能。 |

配置样例如下：

- `thread_pool pool_1 threads=16`;

具体参数说明如下。

- `thread_pool` 也可以编写在 http 指令域中；
- threads参数定义了线程池的线程数；
- max_queue 参数指定了等待队列中的最大任务数，在线程池中所有线程都处于繁忙状态时，新任务将进入等待队列。等待队列中的最大任务数为 65536；
- 线程池指令需要在编译配置时增加`--with-threads`参数；

### 6.2.2 定时器方案指令

| 名 称    | 定时器方案指令                                               |
| :------- | :----------------------------------------------------------- |
| 指令     | timer_resolution                                             |
| 作用域   | main                                                         |
| 默认值   | --                                                           |
| 指令说明 | Nginx 中的处理事件超时管理方案有两种，一种是设定一个定时器，每过一段时间就对所有超时事件进行一次扫描；另一种是先计算出距离当前时间最近的将要发生超时事件的时间，然后等待这个时间之后再去进行一次超时检测。默认配置下使用第二种超时检测方案，该方案是依据事件超时时间与当前时间的时间差进行检测的，所以每次事件返回都需要进行新的检测时间计算，在 I/O 事件比较多的场景下，这会导致频繁地调用时间函数 gettimeofday 进行计算并更新下次检测的时间，资源消耗相对较高。而设置一个指定的时间值启用第一种方案时，Nginx 内置的事件超时检测定时器会在指定时间周期内进行事件超时检测，无须调用时间函数 gettimeofday 更新时间，资源消耗相对较低 |

配置样例如下：

- `timer_resolution 100ms`;

在因频繁调用时间函数引发的资源消耗不大的场景中可不设定该指令。

### 6.2.3 工作进程优先级指令

| 名 称    | 工作进程优先级指令                                           |
| :------- | :----------------------------------------------------------- |
| 指令     | worker_priority                                              |
| 作用域   | main                                                         |
| 默认值   | 0                                                            |
| 指令说明 | 工作进程优先级设定指令，可以通过该指令设定工作进程在 Linux 系统中的优先级（nice值） |

配置样例如下：

- `worker_priority -5`;

worker_priority 指令值的取值范围是 -20～19，数值越小，优先级越高，获得的 CPU 时间就越多。配置生效后可以通过如下命令查看：

- `ps axo command,pid,ni | grep nginx | grep -v grep`；

### 6.2.4 工程进程数指令

| 名 称      | 工作进程数指令                                               |
| :--------- | :----------------------------------------------------------- |
| 指令       | worker_processes                                             |
| 作用域     | main                                                         |
| 默认值     | 1                                                            |
| 可配置选项 | number 或 auto                                               |
| 指令说明   | 依据 Nginx 架构可知，工作进程数量的最佳配置是小于或等于 CPU 内核的数量。通过该指令可以手动设置工作进程的数量，该指令也支持 auto 指令值，由 Nginx 进行自动分配 |

配置样例如下：

- `worker_processes auto`;

工作进程数指令的指令值有两种类型，分别为数字和 auto。指令值为 auto 时，Nginx 会根据 CPU 的内核数生成等数量的工作进程。

### 6.2.5 工程进程CPU绑定指令

| 名 称      | 工作进程 CPU 绑定指令                                        |
| :--------- | :----------------------------------------------------------- |
| 指令       | worker_cpu_affinity                                          |
| 作用域     | main                                                         |
| 默认值     | --                                                           |
| 可配置选项 | cpumark 或 auto                                              |
| 指令说明   | Nginx 工作进程处于高效的工作状态是因为充分利用了进程与 CPU 的亲缘性，使每个工作进程均可固定在一个 CPU 上运行。该指令可以手动进行工作进程与 CPU 的绑定，当然也可以通过设定指令值 auto 交由 Nginx 自动分配 |

配置样例如下：

```shell
worker_processes 8;
worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;
```

指令值是用 CPU 掩码来表示的，使用与 CPU 数量相等位数的二进制值来表示。单个 CPU 用单个二进制值表示，多个 CPU 组合可用二进制值相加来表示。如配置样例所示，CPU 有 8 个核，分别表示绑定了从第 0 核到第 7 核的 CPU。CPU 核数是从 0 开始计数的。

指令值除了可以是 CPU 掩码外，还可以是 auto。当指令值为 auto 时，Nginx 会自动进行 CPU 绑定，配置样例如下：

```shell
worker_processes auto; 
worker_cpu_affinity auto;
```

工作进程与 CPU 核数也可以是多种对应组合，指令语句如下：

```shell
worker_processes 4; 
worker_cpu_affinity 01 10 01 10; # 表示把第1、3工作进程绑定在2核CPU的第0核，第2、4工作
                 # 进程绑定在2核CPU的第1核

worker_processes 2; 
worker_cpu_affinity 0101 1010;  # 表示把第1工作进程绑定在CPU的第0核和第2核，第2工作进程
                 # 绑定在CPU的第1核和第3核
```

工作进程CPU绑定指令仅适合于FreeBSD和Linux操作系统。

